function makeTable(a,b){var c=thead.selectAll("th").data(a).text(String);c.enter().append("th").text(String).style("border-bottom-width","1px"),c.exit().remove(),thead.insert("th","th").style("border-bottom-width","1px");var d=tbody.selectAll("tr").data(b);d.select("th div").text(String),d.enter().append("tr").append("th").append("div").style("width",svgSize.toString()+"px").text(String),d.exit().remove();var e=d.selectAll("td").data(a);e.select("svg circle").attr("r",0),e.enter().append("td").on("mouseenter",function(){var a=$(this),b=a.index()-1,c=a.parent().index();backtrack(matrix,c,b)}).attr("data-toggle","popover").attr("data-original-title",0).attr("data-trigger","hover").append("svg").attr("height",svgSize).attr("width",svgSize).append("circle").attr("cx",svgSize/2).attr("cy",svgSize/2).attr("r",0),e.exit().remove(),table.selectAll("th, td").style("vertical-align","middle"),table.selectAll("td").style("line-height",0),svgPath.attr("width",table.style("width")).attr("height",table.style("height")).style("position","absolute").style("top",0).style("left",0),$("td").popover({delay:1e3})}function updateTable(a){var b=d3.max(a,function(a){return Math.abs(d3.max(a,function(a){return a.score}))}),c=d3.scale.linear().domain([0,b]).range([0,svgSize/2]),d=tbody.selectAll("tr").data(a).selectAll("td").data(function(a){return a});d.attr("data-original-title",function(a){return a.score}).attr("data-content",function(a){if(null===a.prev)return"Reset (0)";var b=a.score-a.prev.score;return b===indel?"Indel ("+b+")":seq0[a.col]==seq1[a.row]?"Match ("+b+")":"Mismatch ("+b+")"});var d=d.select("svg circle");d.attr("r",function(a){return c(Math.abs(a.score))}).style("fill",function(a){return a.score<0?"#d2322d":"#39b3d7"}),d.data(function(a){return a}).exit().attr("r",0)}function makeSequences(){void 0===svgAlign&&(svgAlign=d3.select("#alignment").append("svg").attr("height",50).attr("width",1e3).style("opacity",.5),svgSeq0=svgAlign.append("g"),svgSeq1=svgAlign.append("g").attr("transform","translate(0, 40)"))}function displaySequences(a,b){function c(a,b){var c=b.selectAll("rect").data(a).style("fill",function(a){return dnaColors[a]});c.enter().append("rect").attr("width",baseWidth).attr("height",10).attr("x",function(a,b){return b*baseWidth}).style("fill",function(a){return dnaColors[a]}),c.exit().remove()}c(a,svgSeq0),c(b,svgSeq1)}function score(a,b){return a==b?ident:foreign}function oneStep(a,b,c){if(0===b&&0===c)a[0][0]={score:score(seq0[0],seq1[0]),prev:null,row:b,col:c};else if(0===c)a[b][0]={score:a[b-1][0].score+indel,prev:a[b-1][0],row:b,col:c};else if(0===b)a[0][c]={score:a[0][c-1].score+indel,prev:a[0][c-1],row:b,col:c};else{var d,e=a[b-1][c],f=a[b-1][c-1],g=a[b][c-1],h=[e.score+indel,f.score+score(seq0[c],seq1[b]),g.score+indel],i=d3.max(h),j=h.indexOf(i);d=2===j?g:1===j?f:e,a[b][c]={score:i,prev:d,row:b,col:c}}}function oneStepLocal(a,b,c){if(0===b)a[0][c]={score:d3.max([score(seq1[0],seq0[c]),0]),prev:null,row:b,col:c};else if(0===c)a[b][0]={score:d3.max([score(seq1[b],seq0[0]),0]),prev:null,row:b,col:c};else{var d,e=a[b-1][c],f=a[b-1][c-1],g=a[b][c-1],h=[e.score+indel,f.score+score(seq0[c],seq1[b]),g.score+indel,0],i=d3.max(h),j=h.indexOf(i);d=3===j?null:2===j?g:1===j?f:e,a[b][c]={score:i,prev:d,row:b,col:c}}}function eval(a){seq1.length<matrix.length?matrix.splice(seq1.length,matrix.length):d3.range(matrix.length,seq1.length).forEach(function(){matrix.push([])}),matrix.length&&seq0.length<matrix[0].length&&matrix.map(function(a){a.splice(seq0.length,a.length)});for(var b=d3.min([seq1.length,oldSeq1.length]),c=b,d=0;b>d;++d)seq1[d]!=oldSeq1[d]&&(c=d);for(var e=d3.min([seq0.length,oldSeq0.length]),f=e,d=0;e>d;++d)seq0[d]!=oldSeq0[d]&&(f=d);for(var d=c;d<seq1.length;++d)for(var g=f;g<seq0.length;++g)a(matrix,d,g);updateTable(matrix)}function backtrack(a,b,c){for(var d=a[b][c],e=[d];d.prev;)d=d.prev,e.push(d);if(1!==e.length){var f=$("tbody"),g=e.map(function(a){var b=f.children("tr").eq(a.row).children("td").eq(a.col),c=b.position();return c.left+=16,c.top+=16,[c.left,c.top]}),h=svgPath.select("path");h.empty()&&(h=svgPath.append("path")),h.transition().attr("d",d3.svg.line()(g)).attr("stroke","pink").attr("stroke-width",5).attr("fill","none")}}var seq0="",seq1="",oldSeq0="",oldSeq1="",matrix=[],max,svgSize=20,table=d3.select("table"),thead=table.append("thead").append("tr"),tbody=table.append("tbody"),svgPath=d3.select("#matrix").append("svg").attr("width",0).attr("height",0).style("pointer-events","none"),svgAlign,svgSeq0,svgSeq1,baseWidth=35,dnaColors={A:"#47a447",T:"#39b3d7",C:"#ed9c28",G:"#d2322d"};d3.select("#seq0").on("keyup",function(){seq0=this.value.toUpperCase(),makeSequences(),displaySequences(seq0,seq1),makeTable(seq0,seq1),local?eval(oneStepLocal):eval(oneStep)}),d3.select("#seq1").on("keyup",function(){seq1=this.value.toUpperCase(),makeSequences(),displaySequences(seq0,seq1),makeTable(seq0,seq1),local?eval(oneStepLocal):eval(oneStep)});var indel=-4,ident=1,foreign=-3;d3.select("#identity").on("keyup",function(){"-"!=this.value&&(ident=this.value?parseInt(this.value):1,local?eval(oneStepLocal):eval(oneStep))}),d3.select("#foreign").on("keyup",function(){"-"!=this.value&&(foreign=this.value?parseInt(this.value):-3,local?eval(oneStepLocal):eval(oneStep))}),d3.select("#indel").on("keyup",function(){"-"!=this.value&&(indel=this.value?parseInt(this.value):-4,local?eval(oneStepLocal):eval(oneStep))});var local=!1;$("#t0").tab(),$("#t0").on("click",function(){local=!1,eval(oneStep)}),$("#t1").tab(),$("#t1").on("click",function(){local=!0,eval(oneStepLocal)});